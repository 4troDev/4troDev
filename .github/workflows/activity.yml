name: üõ† Update Recent Commit Activity in README

on:
  schedule:
    - cron: '0 * * * *' # Runs every hour
  workflow_dispatch:

jobs:
  update-readme:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Fetch and Update Commit Activity
        run: |
          set -e

          echo "üîÑ Fetching user repos..."
          REPOS_JSON=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/user/repos?per_page=100")

          if echo "$REPOS_JSON" | jq -e 'type == "array"' > /dev/null; then
            REPOS=$(echo "$REPOS_JSON" | jq -r '.[] | select(.full_name != null) | .full_name')
          else
            echo "‚ùå Failed to get user repos"
            echo "$REPOS_JSON"
            exit 1
          fi

          echo "üîÑ Fetching organization repos..."
          ORG_LOGINS=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/user/orgs" | jq -r '.[].login')

          ORG_REPOS=""
          for ORG in $ORG_LOGINS; do
            ORG_JSON=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/orgs/$ORG/repos?per_page=100")

            if echo "$ORG_JSON" | jq -e 'type == "array"' > /dev/null; then
              ORG_REPOS+=$(echo "$ORG_JSON" | jq -r '.[] | select(.full_name != null) | .full_name')$'\n'
            else
              echo "‚ö†Ô∏è Skipping $ORG, bad JSON"
            fi
          done

          ALL_REPOS=$(echo -e "$REPOS\n$ORG_REPOS" | sort | uniq)
          COMMITTED_REPOS=""

          echo "üîç Checking for today's commits..."
          for REPO in $ALL_REPOS; do
            COMMITS=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/$REPO/commits?author=4troDev&since=$(date -u +%Y-%m-%dT00:00:00Z)" \
              | jq -r 'if type=="array" then .[].sha else empty end')

            if [ -n "$COMMITS" ]; then
              COMMITTED_REPOS+="- [$(basename "$REPO")](https://github.com/$REPO)"$'\n'
            fi
          done

          echo "üìù Updating README..."
          awk -v r="$COMMITTED_REPOS" '
            /<!-- CURRENTLY-WORKING-ON:START -->/ {
              print; print r; skip=1; next
            }
            /<!-- CURRENTLY-WORKING-ON:END -->/ { skip=0 }
            skip==0 { print }
          ' README.md > README.tmp && mv README.tmp README.md

      - name: Commit and Push
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: main
          message: "üîÑ update recent project activity"
